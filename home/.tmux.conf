## Environment specific settings should be done in MY_TMUX_CONF_LOCAL

### Variables {{{
MY_TMUX_PREFIX=C-b
MY_TMUX_SHELL=/usr/bin/bash
MY_TMUX_CONF="$HOME/.tmux.conf"
MY_TMUX_CONF_LOCAL="$HOME/.tmux.conf.local"
## }}}

### Key bindings {{{
## Session
bind    c-s   choose-session
## Window
bind    c-w   choose-window
bind    b     next-window
bind    d     previous-window
bind    n     new-window -c "#{pane_current_path}"
bind    1     select-window -t 1
bind    2     select-window -t 2
bind    3     select-window -t 3
bind    4     select-window -t 4
bind    5     select-window -t 5
# bind    m     new-window -c "#{pane_current_path}" sh -c rg
## Pane
bind    a     select-pane -t :.+
bind    s     split-window -vc "#{pane_current_path}"
bind    v     split-window -hc "#{pane_current_path}"
bind    o     rotate-window
bind -r h     resize-pane -L 1
bind -r j     resize-pane -D 1
bind -r k     resize-pane -U 1
bind -r l     resize-pane -R 1
bind -r <     swap-pane -d -t -1
bind -r >     swap-pane -d -t +1
bind -r .     swap-pane -d -t +1
# cd to last pane's pwd (need functions in shell configs)
bind f send-keys "tmuxcd\r"
## }}}
## Titlebar (of window manager) {{{
set -g set-titles on
set -g set-titles-string "#{pane_current_command} : #(echo #{pane_current_path} | sed 's#$HOME#~#g')" # #T #{=5:window_name}

## }}}
## Status bar {{{
set -g status-left "[#S] "
set -g status-left-length 20
set -g status-right "#[bg=white,fg=black,bold] #(echo #{pane_current_path} | sed 's#$HOME#~#g') #[default] [#W]"
set -g status-justify left
set -g status-position top
set -g window-status-current-style fg=yellow
set -g window-status-last-style    fg=white
set -g window-status-format         "#[fg=white,bg=black,bold] #I#F#W #[default]"
set -g window-status-current-format "#[bg=blue ,fg=black,bold] #I#F#W #[default]"
set -g status on

set -g status-style "bold,fg=white,bg=black"

set -g message-style "bold,fg=black,bg=yellow"

## }}}
## Pane border {{{
set -g pane-border-style "fg=blue,bg=default"
set -g pane-active-border-style "fg=yellow,bg=default"

## }}}
## Prefix {{{
unbind C-b
unbind $MY_TMUX_PREFIX
set -g prefix $MY_TMUX_PREFIX
bind $MY_TMUX_PREFIX send-prefix

## }}}
## Default shell {{{
set -g default-shell "$MY_TMUX_SHELL"
set -g default-command "$MY_TMUX_SHELL"
if-shell 'command -v fish' 'set -g default-shell /usr/bin/fish'
if-shell 'command -v fish' 'set -g default-command /usr/bin/fish'
## }}}
## Reload .tmux.conf {{{
bind r source-file "$MY_TMUX_CONF" \; display "Reloaded $MY_TMUX_CONF"

## }}}
## Misc {{{
set  -g escape-time 0       # no delay on Esc
setw -g repeat-time 1000    # time threshold for "bind -r"
set  -g mouse on
set  -g display-time 2200   # status msg duration
set  -g base-index 1        # start window index from 1
setw -g pane-base-index 1   # start pane index from 1
set-option -g focus-events on
# Default terminal / enable cursor style changing. {{{
# I don't fully understand what's happening.
# Ss=xxx seems to tell tmux to convert xxx as cursor-changing command...
set -g default-terminal "screen-256color"
set -ga terminal-overrides ',*:Ss=\E[%p1%d q:Se=\E[2 q'
# Description on Ss and Se: https://invisible-island.net/xterm/terminfo.html
# Workaround1: https://www.reddit.com/r/neovim/comments/7jv6x1/tmux_issue_guicursor_permanently_modifies_cursor/
# Issue is tmux+nvim: https://github.com/neovim/neovim/issues/5096
# }}}

## }}}
### Copy mode (and some copy/paste bindings) {{{
set -g mode-keys vi
bind c copy-mode
bind -T copy-mode-vi Escape send-keys -X cancel

## Drag in copy-mode ==> copy
bind -T copy-mode-vi mousedragend1pane send-keys y
bind -T copy-mode-vi mousedragend3Pane send-keys y

## Press y ==> copy selection
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "xsel -i -p && xsel -o -p | xsel -i -b"

## Press up/down keys ==> scroll
bind -T copy-mode-vi Up send-keys -X scroll-up
bind -T copy-mode-vi Down send-keys -X scroll-down

## Scroll multiple lines with mouse at once
# Without this, scrolling is too slow.
bind -T copy-mode-vi WheelUpPane   send-keys -t= -N 4 Up
# When scrolled up less than 4 lines and run 'send-keys -N 4 Down', an erro ("Not in a mode") occurs.
# So we need to explicitly quit copy mode in this case (using if-shell)
bind -T copy-mode-vi WheelDownPane if-shell -t= 'test #{scroll_position} -lt 4' 'copy-mode -q' 'send-keys -t= -N 4 Down'
# When not in copy mode and WheelUp event happens, it doesn't scroll up be default (just enters the mode)
# So we make it scroll up in this case.
# But in ranger,emacs etc. (can be detected by mouse_any_flag), WheelUp should not trigger copy-mode, rather send raw mouse event with send-keys -M.
bind -n WheelUpPane if-shell -Ft= "#{mouse_any_flag}" 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -N 4 Up'

# Old ones (this one doesn't work well (after Dec.2020?), it seems to set left mouse button always pressed, on WheelUp event.)
# bind -n WheelUpPane if-shell -Ft= "#{mouse_any_flag}" "send-keys -M" \
#   "if-shell -Ft= '#{pane_in_mode}' 'send-keys H; send-keys 4 Up' 'select-pane -t =; copy-mode -e'"
# bind -n WheelDownPane if-shell -Ft= "#{mouse_any_flag}" "send-keys -M" \
#   "if-shell -Ft= \"#{pane_in_mode}\" \"if-shell -t= 'test #{scroll_position} -eq 0 -a #{cursor_y} -ge $(expr #{pane_height} - 1)' 'send-keys q' 'send-keys L; send-keys 4 Down'\""

## (No copy mode) Mouse right click ==> paste
bind -n mousedown3pane run "xsel -o | tmux load-buffer - ; tmux paste-buffer"
bind -n mousedrag3pane if-shell -F -t = "#{mouse_any_flag}" "if -Ft= \"#{pane_in_mode}\" \"copy-mode -m\" \"send-keys -m\"" "copy-mode -m"

## (No copy mode) Press p key ==> paste
bind p run "xsel -o | tmux load-buffer - ; tmux paste-buffer"

# }}}
## Lock {{{
bind    L     lock-client
set -g lock-after-time 0
set -g lock-command asciiquarium

## }}}

## colemakdh {{{
bind -r k     resize-pane -L 1
bind -r n     resize-pane -D 1
bind -r e     resize-pane -U 1
bind -r i     resize-pane -R 1

bind    E     choose-session
bind    w     new-window -c "#{pane_current_path}"

bind -T copy-mode-vi k send-keys -X cursor-left
bind -T copy-mode-vi n send-keys -X cursor-down
bind -T copy-mode-vi e send-keys -X cursor-up
bind -T copy-mode-vi i send-keys -X cursor-right

bind -T copy-mode-vi j send-keys -X search-again
bind -T copy-mode-vi J send-keys -X search-reverse
bind -T copy-mode-vi h send-keys -X next-word-end
bind -T copy-mode-vi H send-keys -X next-space-end

# unei version
# bind -r u     resize-pane -L 1
# bind -r n     resize-pane -D 1
# bind -r e     resize-pane -U 1
# bind -r i     resize-pane -R 1

# bind    E     choose-session
# bind    w     new-window -c "#{pane_current_path}"

# bind -T copy-mode-vi u send-keys -X cursor-left
# bind -T copy-mode-vi n send-keys -X cursor-down
# bind -T copy-mode-vi e send-keys -X cursor-up
# bind -T copy-mode-vi i send-keys -X cursor-right

# bind -T copy-mode-vi k send-keys -X search-again
# bind -T copy-mode-vi K send-keys -X search-reverse
# bind -T copy-mode-vi h send-keys -X next-word-end
# bind -T copy-mode-vi H send-keys -X next-space-end

## }}}

## Load local configuration {{{
if-shell "test -f $MY_TMUX_CONF_LOCAL" "source-file $MY_TMUX_CONF_LOCAL" ""
## }}}
## Notes about local configuration file {{{

# To set secondary prefix key:
#   MY_TMUX_PREFIX2=key
#   unbind $MY_TMUX_PREFIX2
#   set -g prefix2 $MY_TMUX_PREFIX2
#   bind $MY_TMUX_PREFIX2 send-prefix -2

# To change shell:
#   MY_TMUX_SHELL=/path/to/shell
#   set -g default-shell "$MY_TMUX_SHELL"
#   set -g default-command "$MY_TMUX_SHELL"

# }}}

## Notes about tmux {{{

# Session : can be attached and dettached
# Window  : look like tabs
# Pane    : part of window

# 'bind' is an alias for bind-key

# pane-border-fg etc. is replaced by the similar vars like pane-border-style

# how about using send-keys to input ->

# }}}
