#!/bin/sh

[ $# -eq 0 ] && { echo "Usage: $0 PREFIX[/N] [TIMEOUT]"; echo "example: $0 192.168.1 3"; exit 1; }

range=${1:-192.168.1}
tout=${2:-1}

listip='
BEGIN {
    if(1!=match(range,"^[0-9]+\\.[0-9]+\\.[0-9]+(\\.[0-9]+)?(/[0-9]+)?$")){print"Bad IP range: "range;exit 1}
    split(range, a, "/")
    if(a[2]==0)a[2]=24
    split(a[1], b, ".")
    if(b[4]==0)b[4]=0
    if(!(0<=b[1]&&b[1]<256&&0<=b[2]&&b[2]<256&&0<=b[3]&&b[3]<256&&0<=b[4]&&b[4]<256&&0<=a[2]&&a[2]<=32)){print"Bad IP range: "range;exit 1}
    # print b[1]"."b[2]"."b[3]"."b[4]"/"a[2]
    if(checkonly==1)exit
    x = ((b[1]*256+b[2])*256+b[3])*256+b[4]
    y = 2^(32-a[2])
    x = int(x/y)*y
    for(i=0;i<y;i++){
        z=x+i
        o=z%256
        z=int(z/256)
        o=z%256"."o
        z=int(z/256)
        o=z%256"."o
        z=int(z/256)
        o=z"."o
        print o
    }
    exit
}
'

tmpd=$(mktemp -d /tmp/ping-scan-XXXXXXX)

mkfifo "$tmpd/fifo"

awk -v range="$range" -v checkonly=1 "$listip" || exit 1

trap 'kill $ps 2>/dev/null; rm -rf "$tmpd"; exit 1' INT TERM

awk -v range="$range" "$listip" > "$tmpd/fifo" &
ps=$!

# xargs -P is not universally available
while read -r ip; do
    { timeout "$tout" ping -c1 "$ip" && touch "$tmpd/$ip"; } >/dev/null 2>&1 &
    ps="$ps $!"
done < "$tmpd/fifo"
wait $ps

rm -f "$tmpd/fifo"
find "$tmpd" -maxdepth 1 -type f | sed 's#.*/##' | sort -t. -k1,1n -k2,2n -k3,3n -k4,4n \
    | awk -v w1=16 -v w="$(tput cols)" 'BEGIN{n=int(w/w1)}{if(NR%n!=0){printf"%-"w1"s",$0}else{printf"%s\n",$0}}END{if(NR%n!=0)print""}'

rm -rf "$tmpd"
