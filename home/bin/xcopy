#!/bin/sh

text=$1

wsl_enc() { # fix encoding: accepts utf-8 or shift-jis and writes utf-8
    wsl_enc_in=/tmp/wslenctmp1
    wsl_enc_out=/tmp/wslenctmp2
    cat > "$wsl_enc_in"
    echo 0 >&2
    if iconv -f shift-jis -t shift-jis <"$wsl_enc_in" >"$wsl_enc_out" 2>/dev/null; then
        echo 1 >&2
        cat "$wsl_enc_out"
    elif iconv -f utf-8 -t shift-jis <"$wsl_enc_in" >"$wsl_enc_out" 2>/dev/null; then
        echo 2 >&2
        cat "$wsl_enc_out"
    else
        echo 3 >&3
        cat "$wsl_enc_in"
    fi
}

if [ -n "${IS_WSL}${WSL_DISTRO_NAME}${WSL_INTEROP}${WSL_ENV}" ]; then # wsl
    cd / # might fail if pwd is network shared directory etc. so always cd to /
    cat | iconv -f utf-8 -t shift-jis | sh -c "clip.exe" &
    # clip.exe < /dev/stdin & # not work from nvim
    # cat | clip.exe & # works, but sometimes slow
    # cat | sh -c "clip.exe" & # works and fast (why?)
    # Also, must give shift-jis text to clip.exe (otherwise garbage when pasting on windows)
    # { [ -z "$text" ] && cat || echo "$text"; } \
    #     | wsl_enc | sh -c "clip.exe" &

elif command -v xclip >/dev/null; then # xorg
    { [ -z "$text" ] && cat || echo "$text"; } \
        | xclip -selection clipboard -i

fi

